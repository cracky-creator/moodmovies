<?php
require 'config/db.php'; // Fichier de connexion Ã  ta base de donnÃ©es

// RÃ©cupÃ©ration des donnÃ©es du formulaire
$username = trim($_POST['username']);
$email = trim($_POST['email']);
$password = $_POST['password'];

// 1. VÃ©rification du format de l'email
if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
    // Redirection aprÃ¨s 5 secondes
    header("refresh:5;url=register.php");

    echo "L'adresse email n'est pas valide. Redirection vers inscription dans 5s.";

    exit();
}

// 2. VÃ©rification si le nom d'utilisateur existe dÃ©jÃ 
$sql = "SELECT id FROM users WHERE username = ?";
$stmt = $pdo->prepare($sql);
$stmt->execute([$username]);

if ($stmt->rowCount() > 0) {
    // Redirection aprÃ¨s 5 secondes
    header("refresh:5;url=register.php");
    
    echo "Ce nom d'utilisateur est dÃ©jÃ  pris. Choisis-en un autre. Redirection vers inscription dans 5s.";

    exit();
}

// 3. (Optionnel) VÃ©rification si l'email est dÃ©jÃ  utilisÃ©
$sql = "SELECT id FROM users WHERE email = ?";
$stmt = $pdo->prepare($sql);
$stmt->execute([$email]);

if ($stmt->rowCount() > 0) {
    // Redirection aprÃ¨s 3 secondes
    header("refresh:5;url=register.php");
    
    die("Cet email est dÃ©jÃ  utilisÃ©. Essaie avec un autre. Redirection vers inscription dans 5s.");

    exit();
}

// 4. Hashage du mot de passe pour la sÃ©curitÃ©
$hashedPassword = password_hash($password, PASSWORD_DEFAULT);

// 5. Insertion dans la base
$sql = "INSERT INTO users (username, email, password_hash) VALUES (?, ?, ?)";
$stmt = $pdo->prepare($sql);

if ($stmt->execute([$username, $email, $hashedPassword])) {
    echo "Inscription rÃ©ussie ðŸŽ‰";
} else {
    echo "Erreur lors de l'inscription.";
}
?>
